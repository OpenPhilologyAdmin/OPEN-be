# Project details

This is a free, open source web app, developed by the Open Philology project at Leiden University, 
the aim of which is to assist scholars in the work of producing scholarly editions of premodern texts, 
mainly those in Tibetan and Chinese, but with applicability beyond these two linguistic registers.

The general aims of the project:
- provide tools for editing multilingual texts,
- allow for easy export of edited text into standard word
processors/typesetters for further/final typesetting (for paper
publication),
- allow online display of editions, both as completed projects and in
process.

Useful links:
- [Frontend Application](https://github.com/OpenPhilologyAdmin/OPEN-fe)

# Technology stack

- Ruby v3.2.1
- Ruby on Rails v7.0.4
- Redis
- PostgreSQL 

# Project setup instructions
Project should be setup from `staging` branch. 

*Note: M1 users should use `-arch x86_64` flag for any failing installations*

1. Create local .env files
- `cp .env.local.template .env.development.local`
- `cp .env.local.template .env.test.local`

2. Set up ENV variables in `.env.development.local` and `.env.test.local`
- update `DATABASE_URL` with your database username and password
- for `SECRET_KEY_BASE` and `DEVISE_JWT_SECRET_KEY` use two values generated by `rails secret`

3. Install Bundler and gems
- `gem install bundler`
- `bundle install`

4. Instal Lefthook 
- `lefthook install -f`

*If you don't run the above, you won't be able to run tests and use left hook.*

5. Prepare local databases
- `rails db:setup`

6. Start Rails server & Sidekiq background job processor
- `rails server`
- `bundle exec sidekiq -C config/sidekiq.yml`

*Application is running on `http://localhost:3000`*

## Running tests

- `rspec spec` to run tests.

# Testing CI locally

## Requirements

- [docker](https://www.docker.com/products/docker-desktop/)
- [act](https://github.com/nektos/act)

## Commands

- `act -P ubuntu-latest=lucasalt/act_base:latest` to run the actions locally

# API Docs

[Rswag](https://github.com/rswag/rswag/tree/2.3.0) is used to generate API docs semi-automatically.

Documentation is generated in [OpenAPI 3.0.1 interface](https://swagger.io/specification/) based on integration specs built for controllers.

Please use `rails generate rspec:swagger V1::ControllerName` to generate a plain spec file for the controller.
Please enclose specs used to define documentation files in a context with `swagger: true` tag, eg: `context 'swagger docs generation', swagger: true do ... end`.
These will be automatically excluded from "normal" specs. Only tests tagged as `swagger: true` will be used to generate docs.

Once tests are ready, use `RAILS_ENV=test rails rswag` command to generate the JSON file, and `/api-docs` endpoint to preview the documentation in swagger UI.

# Production deployment

We recommend using [Dokku](https://dokku.com/) for building and managing the `staging` & `production` application.

The following `ENV` variables are required in `production` environment:
- `APP_HOST` Rails application host 
- `DATABASE_URL` with the details of production database
- `DEFAULT_SENDER` will be used as a default sender of all the notifications
- `DEVISE_JWT_SECRET_KEY` each environment should have unique key generated by `rails secret`
- `ENVIRONMENT_NAME` used to differentiate environments in Sentry (for example, `staging` and `production`)
- `FRONTEND_APP_CONFIRM_ACCOUNT_URL` the URL to the confirm account page in FE app (`<FE app URL>/confirm-account`)
- `FRONTEND_APP_ORIGINS` allowed FE origins (for CORS)
- `FRONTEND_APP_RESET_PASSWORD_URL` the URL to the reset password form in FE app (`<FE app URL>/new-password`)
- `FRONTEND_APP_SIGN_IN_URL` the URL to the login form in FE app  (`<FE app URL>/sign-in`)
- `FRONTEND_APP_USERS_MANAGEMENT_URL` the URL to users management page in FE app  (`<FE app URL>/manage-users`)
- `RACK_ENV` set to `production`
- `RAILS_ENV` set to `production`
- `RAILS_SERVE_STATIC_FILES` set to `enabled`
- `REDIS_URL` URL to Redis instance
- `SECRET_KEY_BASE` each environment should have unique key generated by `rails secret`
- `SENDGRID_USER_NAME` and `SENDGRID_PASSWORD` with Sendgrid api key
- `SENTRY_DSN` for Sentry config
